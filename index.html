<!DOCTYPE html>
<html ng-app="app">
<head>
  <meta charset="utf-8">
  <title>OfficePlan</title>
  <style type="text/css">
    body {
      margin: 0;
    }
    #info {
      position: fixed;
      width: 300px;
      right: 0;
      top: 0;
      background: #ccc;
    }

    dl {
      margin: 0;
    }
    dt {
      float: left;
      margin-right: 5px;
    }
  </style>
  <script type="text/javascript" src="js/libs/angular.min.js"></script>
</head>
<body ng-controller="appCtrl">
  <input id="search" placeholder="Search" ng-keyup="search($event)">
  <office-plan></office-plan>
  <button id="mode">User</button>
  <div id="info" ng-hide="!data">
    <ul>
      <li><strong class="heading">Name: </strong>{{data.name}}</li>
      <li><strong class="heading">Job title: </strong>{{data.job_title}}</li>
      <li><strong class="heading">Company: </strong>{{data.company}}</li>
      <li><strong class="heading">Address: </strong>{{data.address}}</li>
      <li><strong class="heading">Phone: </strong>{{data.phone}}</li>
      <li><strong class="heading">Email: </strong><a href="mailto:{{data.email}}">{{data.email}}</a></li>
      <li><strong class="heading">Website: </strong><a href="data.website">{{data.website}}</a></li>
      <li><strong class="heading">Skype: </strong><a href="skype:{{data.skype}}">{{data.skype}}</a></li>
      <li><strong class="heading">Birthday: </strong>{{data.birthday}}</li>
    </ul>
  </div>
  <!-- <div id="edit" ng-controller="editCtrl">
    <form class="content"></form>
    <span ng-model="test"></span>
    <div class="control">
      <button id="update">Update</button>
      <button id="remove">Remove</button>
      <button id="create">Create</button>
    </div>
  </div> -->
  <script type="text/javascript" src="js/libs/fabric.min.js"></script>
  <script type="text/javascript">
  (function(){
    var app = angular.module('app', []);

   app.controller('appCtrl', function($scope){
    $scope.search = function(e){
      if(e.keyCode === 13){
        console.log(111)
      }
    }
    $scope.data = null;
    $scope.$on('item:selected', function(e, item){
      $scope.data = item.data.info;
      $scope.$digest();
    });
    $scope.$on('items:unselected', function(){
      $scope.data = null;
      $scope.$digest();
    });
   });

   app.directive('officePlan', function(){
    return {
      restrict: 'E',
      template: '<canvas width="1600" height="997" id="plan"></canvas>',
      controller: function($scope){
        $scope.people = [{
          info: {
            name: 'Алексей Степченков',
            company: 'CHI Software',
            job_title: 'Developer',
            phone: '(063) 846 21 84',
            email: 'aleksey.stepchenkov@chisw.us',
            skype: 'stu_kh',
            birthday: '08/27/1990'
          },
          position: {
            top: 302,
            left: 281
          }
        },{
          info: {
            name: 'Сергей Войчук',
            company: 'CHI Software',
            job_title: 'Developer',
            phone: '(066) 67-80-140',
            email: 'sergey.voichuk@chisw.us',
            skype: 'said.enterprise',
            birthday: '10/31/1984'
          },
          position: {
            top: 236,
            left: 281
          }
        },{
          info: {
            name: 'Рита Стрельницкая',
            company: 'CHI Software',
            job_title: 'Project Manager',
            phone: '(063) 734 32 14',
            email: 'rita.strelnitskaya@chisw.us',
            skype: 'margorayk',
            birthday: '03/13/1984'
          },
          position: {
            top: 202,
            left: 281
          }
        },{
          info: {
            name: 'Дарья Гармаш',
            company: 'CHI Software',
            phone: '(099) 563 41 44',
            email: 'daria.garmash@chisw.us',
            skype: 'lutsenko.darya',
            birthday: '08/22/1987',
            job_title: 'Front-end Trainee'
          },
          position: {
            top: 138,
            left: 281
          }
        },{
          info: {
            name: 'Яромир Козак',
            company: 'CHI Software',
            phone: '(066) 770 07 34',
            email: 'yaromir.kozak@chisw.us',
            skype: 'y_a_r_o_m_i_r',
            birthday: '08/15/1991',
            job_title: 'Developer'
          },
          position: {
            top: 138,
            left: 365
          }
        }];

        $scope.refresh = function(adminMode){
          stage.clear();
          this.renderItems(adminMode);
        };
        $scope.renderItems = function(adminMode){
          $scope.people.forEach(function(item){
            this.renderItem(item, adminMode);
          }.bind(this));
        };
        $scope.renderItem = function(data, moveable){
          var item = new fabric.Circle({
            fill: 'red',
            hasControls: false,
            hasBorders: false,
            lockMovementX: !!moveable,
            lockMovementY: !!moveable,
            radius: 8,
            originY: 'center',
            originX: 'center',
            top: data.position.top,
            left: data.position.left,
            data: data
          });
          stage.add(item);
        };
        $scope.createItem = function(newData, moveable){
          $scope.data.push(newData);
          this.renderItem(newData, moveable);
        };
        $scope.removeItem = function(item){
          var item = _.find(stage.getObjects(), item);
          $scope.data.splice(this.data.indexOf(item.data), 1);
          item.remove();
        };
        $scope.selectItem = function(item){
          this.selectedItem = item;
          item.setColor('blue');
          //this.options.onSelected(item);
          $scope.$emit('item:selected', item);
        };
        $scope.unselectItem = function(item){
          this.selectedItem = null;
          item.setColor('red');
          $scope.$emit('items:unselected');
        };

        var canvas = document.getElementById('plan');
        var stage = new fabric.Canvas(canvas, {
          hoverCursor: 'pointer'
        });
        stage.setBackgroundImage('images/main-bg.jpg', stage.renderAll.bind(stage));

        stage.on('object:selected', function(e){
          var item = e.target;
          item.setColor('blue');
          if($scope.selectedItem){
            $scope.unselectItem($scope.selectedItem);
          }
          $scope.selectItem(item);
        }).on('selection:cleared', function(){
          if($scope.selectedItem){
            $scope.unselectItem($scope.selectedItem);
            //this.options.onClear();
          }
        }).on('object:modified', function(e){
          var item = e.target;
          item.data.position = {top: item.top, left: item.left};
        });

        $scope.renderItems();
      }
    }
   });
  })();
  </script>
  <!--<script type="text/javascript" src="js/main.js"></script>-->
</body>
</html>